{% extends "base.html" %}

{% macro confidence_badge(suggestion) -%}
  {% if suggestion %}
    {% set conf = suggestion.get('confidence', 0) %}
    {% if conf >= 0.85 %}
      <span class="ml-2 rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">Alta</span>
    {% elif conf >= 0.6 %}
      <span class="ml-2 rounded-full bg-amber-100 px-2 py-1 text-xs font-semibold text-amber-700">Media</span>
    {% else %}
      <span class="ml-2 rounded-full bg-rose-100 px-2 py-1 text-xs font-semibold text-rose-700">Baixa</span>
    {% endif %}
  {% endif %}
{%- endmacro %}

{% macro input_class(suggestion) -%}
  {% if suggestion and suggestion.get('confidence') is not none and suggestion.get('confidence') < 0.6 %}
    mt-1 w-full rounded-xl border border-rose-300 bg-rose-50 px-3 py-2
  {% else %}
    mt-1 w-full rounded-xl border border-slate-200 px-3 py-2
  {% endif %}
{%- endmacro %}

{% macro field_value(name, suggestion) -%}{{ (form.get(name) if form and form.get(name) is not none else (suggestion.get('value') if suggestion else '')) | trim }}{%- endmacro %}

{% block content %}
<div class="flex flex-col gap-6">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div>
      <h1 class="text-2xl font-semibold">Revisar ficha importada</h1>
      <p class="mt-1 text-sm text-slate-600">Confira os dados sugeridos e ajuste antes de salvar.</p>
    </div>
    <a class="btn-secondary" href="{{ url_path('/fichas/importar') }}">Reenviar arquivo</a>
  </div>

  {% if errors %}
  <div class="card border border-red-200 bg-red-50 p-4 text-sm text-red-700">
    Corrija os campos destacados antes de salvar.
  </div>
  {% endif %}

  <div class="grid gap-6 lg:grid-cols-3">
    <div class="card p-6 lg:col-span-1">
      <h2 class="text-lg font-semibold">Documento</h2>
      <p class="mt-1 text-sm text-slate-600">{{ document.original_filename }}</p>
      <a class="btn-secondary mt-4 inline-flex" href="{{ url_path('/fichas/importar/' ~ job.id ~ '/arquivo') }}" target="_blank">Abrir arquivo</a>
      {% if document.content_type.startswith('image/') %}
      <img class="mt-4 w-full rounded-xl border border-slate-200" src="{{ url_path('/fichas/importar/' ~ job.id ~ '/arquivo') }}" alt="Documento importado" />
      {% else %}
      <div class="mt-4 text-xs text-slate-500">PDF detectado. Abra para visualizar.</div>
      {% endif %}
    </div>

    <div class="flex flex-col gap-6 lg:col-span-2">
      <div class="card p-6">
        <h2 class="text-lg font-semibold">Processo vinculado</h2>
        {% if processo %}
        <div class="mt-2 text-sm text-slate-600">Selecionado: <strong>{{ process_label(processo) }}</strong></div>
        <a class="btn-secondary mt-3 inline-flex" href="{{ url_path('/fichas/importar/' ~ job.id ~ '/revisar') }}{% if template %}?template_id={{ template.id }}{% endif %}">Trocar processo</a>
        {% else %}
        <p class="mt-2 text-sm text-slate-600">
          Nenhum processo selecionado. Se continuar, um novo processo sera criado a partir dos dados abaixo.
        </p>
        {% if errors and errors.get('process_id') %}
        <p class="mt-2 text-sm text-red-600">{{ errors.get('process_id') }}</p>
        {% endif %}
        <form
          class="mt-4 grid gap-3 rounded-2xl border border-slate-200 bg-white p-4 md:grid-cols-4"
          hx-get="{{ url_path('/fichas/importar/' ~ job.id ~ '/processos') }}"
          hx-target="#processo-results"
        >
          {% if template %}<input type="hidden" name="template_id" value="{{ template.id }}" />{% endif %}
          <input class="rounded-xl border border-slate-200 px-3 py-2" name="numero" placeholder="Numero ou chave" />
          <input class="rounded-xl border border-slate-200 px-3 py-2" name="ano" placeholder="Ano" />
          <input class="rounded-xl border border-slate-200 px-3 py-2" name="interessado" placeholder="Interessado" />
          <input class="rounded-xl border border-slate-200 px-3 py-2" name="assunto" placeholder="Assunto" />
          <button class="btn-secondary md:col-span-4" type="submit">Buscar processos</button>
        </form>
        <div id="processo-results" class="mt-4"></div>
        {% endif %}
      </div>

      <form class="space-y-6" method="post" action="{{ url_path('/fichas/importar/' ~ job.id ~ '/confirmar') }}">
        {% if processo %}
        <input type="hidden" name="process_id" value="{{ processo.id }}" />
        {% endif %}

        <div class="card p-6">
          <h2 class="text-lg font-semibold">Template</h2>
          <p class="mt-1 text-sm text-slate-600">Escolha o template que define os campos extras.</p>
          <select class="mt-4 w-full rounded-xl border border-slate-200 px-3 py-2" name="template_id">
            <option value="">Selecione</option>
            {% for t in templates_list %}
            <option value="{{ t.id }}" {% if template and t.id == template.id %}selected{% endif %}>{{ t.nome }} v{{ t.versao }}</option>
            {% endfor %}
          </select>
          {% if errors and errors.get('template_id') %}
          <p class="mt-2 text-sm text-red-600">{{ errors.get('template_id') }}</p>
          {% endif %}
        </div>
        <div class="card p-6">
          <h2 class="text-lg font-semibold">Campos base</h2>
          <div class="mt-4 grid gap-4 md:grid-cols-2">
            {% set suggestion = base_suggestions.get('process_key') %}
            <div>
              <label class="text-sm font-medium">Chave do processo {{ confidence_badge(suggestion) }}</label>
              <input class="{{ input_class(suggestion) }}" name="process_key" value="{{ field_value('process_key', suggestion) }}" />
              {% if errors and errors.get('process_key') %}
              <p class="text-sm text-red-600">{{ errors.get('process_key') }}</p>
              {% endif %}
            </div>
            {% set suggestion = base_suggestions.get('tc_numero') %}
            <div>
              <label class="text-sm font-medium">TC numero {{ confidence_badge(suggestion) }}</label>
              <input class="{{ input_class(suggestion) }}" name="tc_numero" value="{{ field_value('tc_numero', suggestion) }}" />
              {% if errors and errors.get('tc_numero') %}
              <p class="text-sm text-red-600">{{ errors.get('tc_numero') }}</p>
              {% endif %}
            </div>
            {% set suggestion = base_suggestions.get('ano') %}
            <div>
              <label class="text-sm font-medium">Ano {{ confidence_badge(suggestion) }}</label>
              <input class="{{ input_class(suggestion) }}" name="ano" value="{{ field_value('ano', suggestion) }}" />
              {% if errors and errors.get('ano') %}
              <p class="text-sm text-red-600">{{ errors.get('ano') }}</p>
              {% endif %}
            </div>
            {% set suggestion = base_suggestions.get('data') %}
            <div>
              <label class="text-sm font-medium">Data {{ confidence_badge(suggestion) }}</label>
              <input class="{{ input_class(suggestion) }}" type="date" name="data" value="{{ field_value('data', suggestion) }}" />
              {% if errors and errors.get('data') %}
              <p class="text-sm text-red-600">{{ errors.get('data') }}</p>
              {% endif %}
            </div>
            {% set suggestion = base_suggestions.get('interessado') %}
            <div>
              <label class="text-sm font-medium">Interessado {{ confidence_badge(suggestion) }}</label>
              <input class="{{ input_class(suggestion) }}" name="interessado" value="{{ field_value('interessado', suggestion) }}" />
              {% if errors and errors.get('interessado') %}
              <p class="text-sm text-red-600">{{ errors.get('interessado') }}</p>
              {% endif %}
            </div>
            {% set suggestion = base_suggestions.get('assunto') %}
            <div class="md:col-span-2">
              <label class="text-sm font-medium">Assunto {{ confidence_badge(suggestion) }}</label>
              <textarea class="{{ input_class(suggestion) }}" name="assunto" rows="2" maxlength="100">{{ field_value('assunto', suggestion) }}</textarea>
              {% if errors and errors.get('assunto') %}
              <p class="text-sm text-red-600">{{ errors.get('assunto') }}</p>
              {% endif %}
            </div>
            {% set suggestion = base_suggestions.get('procedencia') %}
            <div>
              <label class="text-sm font-medium">Procedencia {{ confidence_badge(suggestion) }}</label>
              <input class="{{ input_class(suggestion) }}" name="procedencia" value="{{ field_value('procedencia', suggestion) }}" />
              {% if errors and errors.get('procedencia') %}
              <p class="text-sm text-red-600">{{ errors.get('procedencia') }}</p>
              {% endif %}
            </div>
            {% set suggestion = base_suggestions.get('reparticao') %}
            <div>
              <label class="text-sm font-medium">Reparticao {{ confidence_badge(suggestion) }}</label>
              <input class="{{ input_class(suggestion) }}" name="reparticao" value="{{ field_value('reparticao', suggestion) }}" />
              {% if errors and errors.get('reparticao') %}
              <p class="text-sm text-red-600">{{ errors.get('reparticao') }}</p>
              {% endif %}
            </div>
            {% set suggestion = base_suggestions.get('valor') %}
            <div>
              <label class="text-sm font-medium">Valor {{ confidence_badge(suggestion) }}</label>
              <input class="{{ input_class(suggestion) }}" name="valor" value="{{ field_value('valor', suggestion) }}" />
              {% if errors and errors.get('valor') %}
              <p class="text-sm text-red-600">{{ errors.get('valor') }}</p>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="card p-6">
          <h2 class="text-lg font-semibold">Campos extras</h2>
          {% if template_schema %}
            {% for section in template_schema.sections %}
            <div class="mt-6">
              <h3 class="text-base font-semibold">{{ section.label }}</h3>
              {% if section.description %}
              <p class="mt-1 text-sm text-slate-500">{{ section.description }}</p>
              {% endif %}
              <div class="mt-4 grid gap-4 md:grid-cols-12">
                {% for field in section.fields %}
                {% set suggestion = extras_suggestions.get(field.field_id) %}
                {% set value = form.get('extra__' ~ field.field_id) if form and form.get('extra__' ~ field.field_id) is not none else (suggestion.get('value') if suggestion else '') %}
                {% set width = field.layout.width if field.layout and field.layout.width else 6 %}
                <div style="grid-column: span {{ width }} / span {{ width }};">
                  <label class="text-sm font-medium">
                    {{ field.label }}{% if field.required %} *{% endif %} {{ confidence_badge(suggestion) }}
                  </label>
                  {% if field.type == 'textarea' %}
                  <textarea
                    class="{{ input_class(suggestion) }}"
                    name="extra__{{ field.field_id }}"
                    rows="3"
                    {% if field.layout and field.layout.placeholder %}placeholder="{{ field.layout.placeholder }}"{% endif %}
                    {% if field.validations and field.validations.min_length %}minlength="{{ field.validations.min_length }}"{% endif %}
                    {% if field.validations and field.validations.max_length %}maxlength="{{ field.validations.max_length }}"{% endif %}
                    {% if field.required %}required{% endif %}
                  >{{ value }}</textarea>
                  {% elif field.type == 'date' %}
                  <input
                    class="{{ input_class(suggestion) }}"
                    type="date"
                    name="extra__{{ field.field_id }}"
                    value="{{ value }}"
                    {% if field.required %}required{% endif %}
                  />
                  {% elif field.type == 'number' %}
                  <input
                    class="{{ input_class(suggestion) }}"
                    type="number"
                    step="any"
                    name="extra__{{ field.field_id }}"
                    value="{{ value }}"
                    {% if field.validations and field.validations.min_value is not none %}min="{{ field.validations.min_value }}"{% endif %}
                    {% if field.validations and field.validations.max_value is not none %}max="{{ field.validations.max_value }}"{% endif %}
                    {% if field.required %}required{% endif %}
                  />
                  {% elif field.type == 'currency' %}
                  <input
                    class="{{ input_class(suggestion) }}"
                    type="number"
                    step="0.01"
                    name="extra__{{ field.field_id }}"
                    value="{{ value }}"
                    {% if field.validations and field.validations.min_value is not none %}min="{{ field.validations.min_value }}"{% endif %}
                    {% if field.validations and field.validations.max_value is not none %}max="{{ field.validations.max_value }}"{% endif %}
                    {% if field.required %}required{% endif %}
                  />
                  {% elif field.type == 'boolean' %}
                  <div class="mt-2 flex items-center gap-2">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300"
                      name="extra__{{ field.field_id }}"
                      value="true"
                      {% if value in ['true', 'True', True] %}checked{% endif %}
                      {% if field.required %}required{% endif %}
                    />
                    <span class="text-sm text-slate-600">Sim</span>
                  </div>
                  {% elif field.type == 'enum' %}
                  <select
                    class="{{ input_class(suggestion) }}"
                    name="extra__{{ field.field_id }}"
                    {% if field.required %}required{% endif %}
                  >
                    <option value="">Selecione</option>
                    {% for option in field.options %}
                    <option value="{{ option }}" {% if value == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                  </select>
                  {% else %}
                  <input
                    class="{{ input_class(suggestion) }}"
                    name="extra__{{ field.field_id }}"
                    value="{{ value }}"
                    {% if field.layout and field.layout.placeholder %}placeholder="{{ field.layout.placeholder }}"{% endif %}
                    {% if field.validations and field.validations.min_length %}minlength="{{ field.validations.min_length }}"{% endif %}
                    {% if field.validations and field.validations.max_length %}maxlength="{{ field.validations.max_length }}"{% endif %}
                    {% if field.validations and field.validations.regex %}pattern="{{ field.validations.regex }}"{% endif %}
                    {% if field.required %}required{% endif %}
                  />
                  {% endif %}
                  {% if errors and errors.get('extra__' ~ field.field_id) %}
                  <p class="text-sm text-red-600">{{ errors.get('extra__' ~ field.field_id) }}</p>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
            </div>
            {% endfor %}
          {% else %}
          <p class="mt-3 text-sm text-slate-600">Selecione um template para visualizar os campos extras.</p>
          {% endif %}
        </div>

        <div class="card p-6">
          <h2 class="text-lg font-semibold">Outros dados</h2>
          <div class="mt-4 grid gap-4 md:grid-cols-3">
            {% set suggestion = base_suggestions.get('indexador') %}
            <div>
              <label class="text-sm font-medium">Indexador {{ confidence_badge(suggestion) }}</label>
              <input class="{{ input_class(suggestion) }}" name="indexador" value="{{ field_value('indexador', suggestion) }}" />
              {% if errors and errors.get('indexador') %}
              <p class="text-sm text-red-600">{{ errors.get('indexador') }}</p>
              {% endif %}
            </div>
            <div>
              <label class="text-sm font-medium">Status</label>
              {% set status_value = form.get('status') if form and form.get('status') is not none else 'ativo' %}
              <select class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2" name="status">
                <option value="ativo" {% if status_value == 'ativo' %}selected{% endif %}>Ativo</option>
                <option value="rascunho" {% if status_value == 'rascunho' %}selected{% endif %}>Rascunho</option>
                <option value="arquivado" {% if status_value == 'arquivado' %}selected{% endif %}>Arquivado</option>
              </select>
              {% if errors and errors.get('status') %}
              <p class="text-sm text-red-600">{{ errors.get('status') }}</p>
              {% endif %}
            </div>
            {% set suggestion = base_suggestions.get('observacoes') %}
            <div>
              <label class="text-sm font-medium">Observacoes {{ confidence_badge(suggestion) }}</label>
              <textarea class="{{ input_class(suggestion) }}" name="observacoes" rows="3">{{ field_value('observacoes', suggestion) }}</textarea>
              {% if errors and errors.get('observacoes') %}
              <p class="text-sm text-red-600">{{ errors.get('observacoes') }}</p>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="flex flex-wrap gap-3">
          <button class="btn-primary btn-primary-lg" type="submit">Salvar ficha</button>
          <a class="btn-secondary" href="{{ url_path('/fichas/importar/' ~ job.id) }}">Voltar ao status</a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
