{% extends "base.html" %}

{% block content %}
<div class="flex items-center justify-between">
  <div>
    <h1 class="text-2xl font-semibold">Ficha {{ ficha.id }}</h1>
    <p class="text-sm text-slate-600">Template: {{ ficha.template.nome }} v{{ ficha.template.versao }}</p>
    {% if ficha.template.origem_pdf %}
    <p class="text-xs text-slate-500">Origem: {{ ficha.template.origem_pdf }}</p>
    {% endif %}
    <p class="text-xs text-slate-500">Status: {{ ficha.status }}</p>
  </div>
  <div class="flex gap-2">
    <a class="btn-secondary" href="{{ url_path('/fichas/' ~ ficha.id ~ '/editar') }}">Editar</a>
    <form method="post" action="{{ url_path('/fichas/' ~ ficha.id ~ '/excluir') }}" onsubmit="return confirm('Excluir esta ficha?');">
      <button class="btn-danger" type="submit">Excluir</button>
    </form>
  </div>
</div>

<div class="mt-6 grid gap-6 md:grid-cols-2">
  <div class="card p-6">
    <h2 class="text-lg font-semibold">Campos base (snapshot)</h2>
    <dl class="mt-4 space-y-2 text-sm">
      {% for key, value in ficha.campos_base_json.items() %}
      <div><strong>{{ key }}:</strong> {{ value if value is not none else '-' }}</div>
      {% endfor %}
    </dl>
  </div>
  <div class="card p-6">
    <h2 class="text-lg font-semibold">Campos extras</h2>
    {% if ficha.extras_json %}
    <dl class="mt-4 space-y-2 text-sm">
      {% for key, value in ficha.extras_json.items() %}
      {% set field = extras_map.get(key) if extras_map is defined else None %}
      <div><strong>{{ field.label if field else key }}:</strong> {{ value if value is not none else '-' }}</div>
      {% endfor %}
    </dl>
    {% else %}
    <p class="mt-4 text-sm text-slate-600">Sem campos extras.</p>
    {% endif %}
  </div>
</div>

<div class="mt-6 grid gap-6 md:grid-cols-2">
  <div class="card p-6">
    <h2 class="text-lg font-semibold">Observacoes</h2>
    <p class="mt-4 text-sm text-slate-700">{{ ficha.observacoes or 'Sem observacoes.' }}</p>
  </div>
  <div class="card p-6">
    <h2 class="text-lg font-semibold">Anexos</h2>
    <form class="mt-4 flex items-center gap-2" method="post" enctype="multipart/form-data" action="{{ url_path('/fichas/' ~ ficha.id ~ '/anexos') }}">
      <input type="file" name="file" class="text-sm" />
      <button class="btn-primary" type="submit">Enviar</button>
    </form>
    <ul class="mt-4 space-y-2 text-sm">
      {% for attachment in ficha.attachments %}
      <li class="flex items-center justify-between">
        <span>{{ attachment.filename }}</span>
        <a class="btn-secondary" href="{{ url_path('/anexos/' ~ attachment.id) }}">Abrir</a>
      </li>
      {% else %}
      <li class="text-slate-600">Sem anexos.</li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endblock %}
